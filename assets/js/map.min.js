import{popupHTML as e}from"./popup.min.js";import{computeEstatus as t}from"./utils.min.js";import{filterData as o}from"./filters.min.js";import{updateKPIs as r}from"./charts.min.js";import{pointInPolygon as i}from"./utils.min.js";let n=null,l=null,a=null,s={timeRange:null,polygon:null,polygonMode:"inside",zone:null};export function getMapInstance(){return n}export function getRawData(){return l}export function updateExternalFilters(e){s="clear"===e?{timeRange:null,polygon:null,polygonMode:"inside",zone:null}:{...s,...e},refreshMapData()}export function initMap(i){n=new maplibregl.Map({container:"mapView",style:{version:8,glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",sources:{"osm-tiles":{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"Â© OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles"}]},center:[-78.619,-1.25],zoom:14.1,hash:!0}),n.addControl(new maplibregl.NavigationControl,"top-right"),n.on("load",async()=>{const s=await fetch("data/negocios.geojson").then(e=>e.json());s.features.forEach(e=>{e.properties.estatus=t(e.properties)}),l=s,a=o(l),n.addSource("negocios",{type:"geojson",data:a,cluster:!0,clusterMaxZoom:16,clusterRadius:40}),n.addLayer({id:"clusters",type:"circle",source:"negocios",filter:["has","point_count"],paint:{"circle-color":"#374151","circle-radius":["step",["get","point_count"],16,10,20,25,28],"circle-opacity":.85}}),n.addLayer({id:"cluster-count",type:"symbol",source:"negocios",filter:["has","point_count"],layout:{"text-field":["get","point_count_abbreviated"],"text-size":12},paint:{"text-color":"#ffffff"}}),n.addLayer({id:"unclustered",type:"circle",source:"negocios",filter:["!",["has","point_count"]],paint:{"circle-radius":7,"circle-stroke-width":1.5,"circle-stroke-color":"#ffffff","circle-color":["case",["==",["get","estatus"],"formal"],"#2563eb",["==",["get","estatus"],"informal"],"#f59e0b","#ef4444"]}}),n.on("click","unclustered",t=>{const o=t.features[0],r=o.properties;(new maplibregl.Popup).setLngLat(t.lngLat).setHTML(e(r)).addTo(n),window.dispatchEvent(new CustomEvent("business-clicked",{detail:o}))}),n.addSource("poly-filter",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),n.addLayer({id:"poly-filter-fill",type:"fill",source:"poly-filter",paint:{"fill-color":"#2563eb","fill-opacity":.12}}),n.addLayer({id:"poly-filter-line",type:"line",source:"poly-filter",paint:{"line-color":"#2563eb","line-width":2}}),i&&i(),r(a)})}export function refreshMapData(){if(!l)return;if(a=o(l),s.timeRange){const[e,t]=s.timeRange;a={type:"FeatureCollection",features:a.features.filter(o=>{const r=Number(o.properties?.anio_inicio);return!Number.isFinite(r)||r>=e&&r<=t})}}if(s.zone&&(a={type:"FeatureCollection",features:a.features.filter(e=>(e.properties?.zona||"")===s.zone)}),s.polygon){const e=s.polygon.geometry.coordinates[0];a={type:"FeatureCollection",features:a.features.filter(t=>{const o=i(t.geometry.coordinates,e);return"inside"===s.polygonMode?o:!o})}}const e=n.getSource("negocios");e&&e.setData(a);const t=n.getSource("poly-filter");if(t){const e=s.polygon?{type:"FeatureCollection",features:[s.polygon]}:{type:"FeatureCollection",features:[]};t.setData(e)}r(a),window.dispatchEvent(new CustomEvent("map-data-updated"))}